OPT=opt
LLVMDIS=llvm-dis
LLVMAS=llvm-as
LLC=llc

TEST_DIR=../../

UTILS_DIR=${TEST_DIR}/utils
INCLUDE_DIR=${UTILS_DIR}
RUN_SH=${UTILS_DIR}/run.pl  
ALLIN_HOME=${TEST_DIR}/../build/


#ICC=$(shell which icc)
outdir=Output/
CC=clang
CXX=clang++

# ALLVM dependency

#SKIP_MCSEMA=-skip_mcsema
#SKIP_MCSEMA=
PRINT=-print
MASTER="--master"
SHELL = bash


.PHONY:run

#all:    cfg
all:    clang

cfg:
	@echo -e "\e[4m\e[1m\e[34mRun Command\e[0m"
	mkdir -p ${outdir}
	${RUN_SH} -file ${PROG_PREFIX}.${ASM_FILE} -arch 64 ${SKIP_MCSEMA} -map ${FUNC_MAP} -entry ${ENTRY_FUNC} -compiler clang -suffix clang -incdir ${INCLUDE_DIR}  ${PRINT}	 -cfg -home ${MCSEMA_HOME} -driver ${DRIVER} -allin_home ${ALLIN_HOME} ${MASTER}

gcc:
	@echo " Using gcc"
	COMPILER=gcc ENTRY_FUNC=${ENTRY_FUNC} ASM_FILE=${ASM_FILE} FUNC_MAP=${FUNC_MAP} ${RUN_SH} ${PROG_PREFIX} 64
icc:
	@echo " using icc"
	@COMPILER=icc ENTRY_FUNC=${ENTRY_FUNC} ASM_FILE=${ASM_FILE} FUNC_MAP=${FUNC_MAP} ${RUN_SH} ${PROG_PREFIX} 64


clang:
	@echo ""
	@echo -e "\e[4m\e[1m\e[34m${PROG_PREFIX}\e[0m"
	mkdir -p ${outdir}
	${RUN_SH} -file ${PROG_PREFIX}.${ASM_FILE} -arch 64 ${SKIP_MCSEMA} -map ${FUNC_MAP} -entry ${ENTRY_FUNC} -compiler clang -suffix clang -incdir ${INCLUDE_DIR}  ${PRINT}	  -home ${MCSEMA_HOME}  ${MASTER} -driver ${DRIVER} -allin_home ${ALLIN_HOME} -extract_bc

run_pass:
	${RUN_SH} -file ${PROG_PREFIX}.${ASM_FILE} -arch 64 ${SKIP_MCSEMA} -map ${FUNC_MAP} -entry ${ENTRY_FUNC} -compiler clang -suffix clang -incdir ${INCLUDE_DIR}  ${PRINT}	 -runpass -home ${MCSEMA_HOME} -stdin_args  ${STDIN_ARGS} -cmd_args ${CMD_ARGS} ${MASTER} -driver ${DRIVER} -allin_home ${ALLIN_HOME} 
	#${MAKE} ext="clang" test_allexe

test_allexe:
	${RUN_SH} -file ${PROG_PREFIX}.${ASM_FILE} -arch 64 ${SKIP_MCSEMA} -map ${FUNC_MAP} -entry ${ENTRY_FUNC} -compiler clang -suffix clang -incdir ${INCLUDE_DIR}  ${PRINT}	 -testallexe -home ${MCSEMA_HOME} -stdin_args  ${STDIN_ARGS} -cmd_args ${CMD_ARGS} ${MASTER} -driver ${DRIVER} -allin_home ${ALLIN_HOME} 


clean:

	@../../utils/clearall.sh
	@rm -rf log *.dot *.mod



